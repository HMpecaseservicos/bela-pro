generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  STAFF
}

enum AppointmentStatus {
  PENDING
  PENDING_PAYMENT  // Aguardando pagamento PIX
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum ClientStatus {
  NORMAL
  PONTUAL
  ATRASOU
  FALTOU
}

enum CancelledBy {
  CLIENT
  PROFESSIONAL
  SYSTEM
}

enum ChatChannel {
  WHATSAPP
}

enum ChatConversationState {
  START
  CHOOSE_SERVICE
  CHOOSE_DATE
  CHOOSE_TIME
  CONFIRM
  DONE
  HUMAN_HANDOFF
}

enum NotificationType {
  APPOINTMENT_CONFIRMATION
  REMINDER_24H
  REMINDER_2H
}

// Eventos de mensagem configuráveis (sistema de templates manuais)
enum MessageEventType {
  APPOINTMENT_CREATED       // Agendamento criado (aguardando confirmação)
  APPOINTMENT_CONFIRMED     // Agendamento confirmado
  APPOINTMENT_COMPLETED     // Serviço concluído
  APPOINTMENT_REMINDER_24H  // Lembrete 24h antes
  APPOINTMENT_REMINDER_2H   // Lembrete 2h antes
  APPOINTMENT_CANCELLED     // Agendamento cancelado
}

// ==================== PAGAMENTO PIX ====================

enum PaymentType {
  NONE             // Sem exigência de pagamento
  FULL             // Valor total do serviço
  PARTIAL_PERCENT  // Percentual do valor (sinal)
  PARTIAL_FIXED    // Valor fixo (sinal)
}

enum PixKeyType {
  CPF
  CNPJ
  EMAIL
  PHONE
  RANDOM
}

enum PaymentStatus {
  PENDING    // Aguardando pagamento
  PAID       // Pago (confirmado manualmente)
  CANCELLED  // Cancelado (expirado ou cancelamento)
  REFUNDED   // Reembolsado (futuro)
}

model Workspace {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name      String
  slug      String   @unique
  timezone  String   @default("America/Sao_Paulo")

  // Identidade visual básica
  brandName String?  // ex.: "Studio da Ana"
  primaryColorHex String? // ex.: #A855F7
  accentColorHex String?  // Cor secundária/destaque
  logoUrl String?  // URL do logo
  coverImageUrl String?  // Imagem de capa (hero)
  galleryUrls String[]  // Array de URLs do portfólio
  themePreset String?  // Preset: rose_gold, burgundy, olive_green, classic_dark, ocean_blue, custom

  // Textos customizáveis da página pública
  welcomeText String?  // "Agende seu horário conosco!"
  description String?  // Descrição do negócio

  // Regras globais (MVP)
  minLeadTimeMinutes  Int @default(120)
  bufferMinutes       Int @default(10)
  maxBookingDaysAhead Int @default(60)
  cancelMinMinutes    Int @default(120)
  slotIntervalMinutes Int @default(15)  // Intervalo entre slots: 15, 30, 60

  // Plano e billing
  plan WorkspacePlan @default(BASIC)  // Plano do workspace
  chatbotEnabled Boolean @default(true)  // Chatbot ativo/inativo

  // WhatsApp (conexão simplificada via Evolution API)
  whatsappEvolutionInstanceName String? @unique
  whatsappLastConnectionState   String?
  whatsappLastConnectedAt       DateTime?
  whatsappWebhookUrl            String?

  // ==================== PAGAMENTO PIX ====================
  // Configurações de cobrança para confirmação de agendamento
  requirePayment       Boolean      @default(false)  // Exigir pagamento para confirmar
  paymentType          PaymentType  @default(NONE)   // Tipo de cobrança
  partialPercent       Int?                          // Percentual do sinal (10-100)
  partialFixedAmount   Decimal?     @db.Decimal(10,2) // Valor fixo do sinal
  paymentExpiryMinutes Int          @default(30)     // Minutos para expirar o pagamento

  // Dados do PIX do estabelecimento
  pixKeyType           PixKeyType?                   // Tipo da chave PIX
  pixKey               String?                       // Chave PIX
  pixHolderName        String?                       // Nome do titular
  pixCity              String?                       // Cidade (para QR Code)

  memberships  Membership[]
  inviteTokens InviteToken[]
  profile      ProfessionalProfile?
  services     Service[]
  bundles      ServiceBundle[]
  clients      Client[]
  appointments Appointment[]
  scheduleRules ScheduleRule[]
  timeOffs     TimeOff[]
  manualBlocks ManualBlock[]
  chatTemplates ChatbotTemplate[]
  conversations ChatbotConversation[]
  notificationJobs NotificationJob[]
  auditLogs    AuditLog[]
  messageTemplates MessageTemplate[]
  chatUsages   ChatUsage[]  // Histórico de uso mensal
  
  // Módulo financeiro
  financialCategories  FinancialCategory[]
  financialTransactions FinancialTransaction[]
  
  // Sistema de planos e billing
  subscription WorkspaceSubscription?
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name      String
  email     String
  passwordHash String

  isActive  Boolean @default(true)
  
  // Super Admin: acesso global a todos os workspaces
  isSuperAdmin Boolean @default(false)

  memberships Membership[]
  auditLogs   AuditLog[]

  @@unique([email])
}

model Membership {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  role     UserRole @default(OWNER)
  isActive Boolean  @default(true)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

model ProfessionalProfile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  displayName String
  phoneE164   String?
  addressLine String?
  notes       String?
}

// Token de convite para membros da equipe
model InviteToken {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  token     String   @unique  // Token único para URL
  email     String             // Email do convidado
  name      String             // Nome do convidado
  role      UserRole @default(STAFF)

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  invitedById String            // Quem enviou o convite
  
  expiresAt DateTime            // Expira em 7 dias
  usedAt    DateTime?           // Quando foi aceito (null = pendente)

  @@index([token])
  @@index([workspaceId])
  @@index([email, workspaceId])
}

model Service {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  name        String
  description String?
  durationMinutes Int
  priceCents  Int

  isActive      Boolean @default(true)
  showInBooking Boolean @default(true)  // Exibir na página pública?
  sortOrder     Int     @default(0)     // Ordem de exibição
  
  // Campos premium para exibição
  imageUrl    String?  // Foto real do serviço
  badgeText   String?  // Badge ("Mais pedido", "Novidade")
  categoryTag String?  // Categoria ("sobrancelha", "unhas")

  appointmentServices AppointmentService[]
  bundleItems ServiceBundleItem[]

  @@index([workspaceId, isActive])
  @@index([workspaceId, showInBooking, sortOrder])
  @@unique([workspaceId, name])
}

model ServiceBundle {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  name        String
  description String?
  isActive    Boolean @default(true)

  items       ServiceBundleItem[]

  @@unique([workspaceId, name])
}

model ServiceBundleItem {
  id        String   @id @default(cuid())

  bundleId  String
  bundle    ServiceBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  sortOrder Int @default(0)

  @@unique([bundleId, serviceId])
}

model Client {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  name        String
  phoneE164   String
  notesInternal String?
  status      ClientStatus @default(NORMAL)

  appointments Appointment[]
  financialTransactions FinancialTransaction[]

  @@unique([workspaceId, phoneE164])
  @@index([workspaceId])
}

model Appointment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  clientId   String
  client     Client @relation(fields: [clientId], references: [id], onDelete: Restrict)

  startAt    DateTime
  endAt      DateTime

  status     AppointmentStatus @default(PENDING)

  // origem do agendamento
  bookedVia  String @default("admin") // admin | public | whatsapp

  cancelledAt DateTime?
  cancelledBy CancelledBy?
  cancelReason String?

  // Lembrete automático
  reminderSentAt DateTime? // quando o lembrete foi enviado

  // Financeiro MVP: snapshot
  totalPriceCents Int @default(0)

  services   AppointmentService[]
  notifications NotificationJob[]
  payment    Payment?  // Pagamento associado (quando requirePayment = true)
  financialTransaction FinancialTransaction?  // Transação financeira associada

  @@index([workspaceId, startAt])
  @@index([workspaceId, status])
}

model AppointmentService {
  id            String @id @default(cuid())

  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  serviceId     String
  service       Service @relation(fields: [serviceId], references: [id], onDelete: Restrict)

  durationMinutes Int
  priceCents      Int

  @@index([appointmentId])
  @@index([serviceId])
}

// ==================== PAGAMENTO PIX ====================
// Registro de pagamento para confirmação de agendamento
model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  // Valores
  amountCents     Int                // Valor a pagar em centavos
  serviceTotalCents Int              // Valor total do serviço (referência)

  // Status do pagamento
  status      PaymentStatus @default(PENDING)

  // PIX (cópia e cola gerado)
  pixCode     String?       @db.Text  // Código PIX "copia e cola" ou payload BR Code
  pixQrBase64 String?       @db.Text  // QR Code em base64 (opcional)

  // Controle de expiração
  expiresAt   DateTime               // Quando o pagamento expira

  // Confirmação manual
  paidAt      DateTime?              // Quando foi confirmado
  confirmedBy String?                // ID do usuário que confirmou

  // Notas
  notes       String?                // Observações (ex: "comprovante recebido via WhatsApp")

  @@index([status])
  @@index([expiresAt])
}

model ScheduleRule {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // 0=Domingo..6=Sábado
  dayOfWeek Int

  startTimeMinutes Int // ex.: 9*60
  endTimeMinutes   Int // ex.: 18*60

  isActive Boolean @default(true)

  @@index([workspaceId, dayOfWeek, isActive])
}

model TimeOff {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  startAt DateTime
  endAt   DateTime
  reason  String?

  @@index([workspaceId, startAt])
}

model ManualBlock {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  startAt DateTime
  endAt   DateTime
  reason  String?

  @@index([workspaceId, startAt])
}

model ChatbotTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  key     String // ex.: CONFIRMATION, REMINDER_24H
  content String
  isActive Boolean @default(true)

  @@unique([workspaceId, key])
}

model ChatbotConversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  channel  ChatChannel @default(WHATSAPP)
  phoneE164 String

  state    ChatConversationState @default(START)
  contextJson Json?

  isHumanHandoff Boolean @default(false)

  messages ChatbotMessage[]

  @@unique([workspaceId, channel, phoneE164])
  @@index([workspaceId])
}

model ChatbotMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  conversationId String
  conversation   ChatbotConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  direction String // in | out
  text      String
  rawJson   Json?

  @@index([conversationId, createdAt])
}

model NotificationJob {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  type      NotificationType
  runAt     DateTime

  status    String @default("SCHEDULED") // scheduled|processing|sent|failed|cancelled
  attempts  Int @default(0)
  lastError String?

  @@index([workspaceId, runAt])
  @@index([appointmentId])
}

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  actorUserId String?
  actorUser   User? @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  action   String
  entity   String
  entityId String
  metadata Json?

  @@index([workspaceId, createdAt])
}

// Templates de mensagem configuráveis por workspace (envio manual)
model MessageTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  eventType   MessageEventType  // Tipo do evento (APPOINTMENT_CREATED, etc.)
  enabled     Boolean @default(true)  // Ativo/Inativo
  message     String  // Texto do template com variáveis {{clientName}}, etc.
  
  allowClientReply Boolean @default(false)  // Espera resposta do cliente?

  @@unique([workspaceId, eventType])
  @@index([workspaceId])
}

// ============================================================================
// BILLING: Controle de uso de conversas por workspace
// Segue o modelo Meta: 1 conversa = janela de 24h
// ============================================================================

enum WorkspacePlan {
  FREE        // Teste gratuito
  BASIC       // Plano básico
  PRO         // Plano profissional
  ENTERPRISE  // Plano enterprise
}

model ChatUsage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Período de faturamento (YYYY-MM)
  yearMonth String  // ex: "2026-01"

  // Contadores de conversas
  conversationsUsed   Int @default(0)  // Conversas dentro do limite
  conversationsLimit  Int              // Limite do mês (vem do plano)
  excessConversations Int @default(0)  // Conversas excedentes (para cobrança)

  // Metadados para auditoria
  lastConversationAt DateTime?  // Última conversa registrada
  
  @@unique([workspaceId, yearMonth])
  @@index([workspaceId])
  @@index([yearMonth])
}

// Histórico detalhado de cada conversa para billing (auditoria)
model ConversationBillingEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  workspaceId String
  
  // Referência à conversa
  conversationId String
  phoneE164      String
  
  // Janela de 24h
  windowStartAt DateTime  // Início da janela de 24h
  windowEndAt   DateTime  // Fim da janela de 24h
  
  // Status do billing
  isExcess      Boolean @default(false)  // Se foi contabilizado como excedente
  yearMonth     String  // Mês de referência

  @@index([workspaceId, yearMonth])
  @@index([conversationId])
  @@index([windowEndAt])  // Para queries de janelas ativas
}

// ==================== MÓDULO FINANCEIRO ====================

enum TransactionType {
  INCOME    // Receita (entrada)
  EXPENSE   // Despesa (saída)
}

enum TransactionStatus {
  PENDING   // Pendente (a receber ou a pagar)
  COMPLETED // Concluído (recebido ou pago)
  CANCELLED // Cancelado
}

enum PaymentMethod {
  PIX
  CASH        // Dinheiro
  CREDIT_CARD // Cartão de crédito
  DEBIT_CARD  // Cartão de débito
  TRANSFER    // Transferência bancária
  OTHER
}

// Categorias financeiras (receitas e despesas)
model FinancialCategory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  name        String             // Nome da categoria
  type        TransactionType    // INCOME ou EXPENSE
  icon        String?            // Emoji ou ícone
  color       String?            // Cor hex para visualização
  isSystem    Boolean @default(false)  // Categorias do sistema não podem ser excluídas
  isActive    Boolean @default(true)

  transactions FinancialTransaction[]

  @@index([workspaceId, type])
  @@unique([workspaceId, name, type])
}

// Transações financeiras (receitas e despesas)
model FinancialTransaction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Tipo e status
  type          TransactionType     // INCOME ou EXPENSE
  status        TransactionStatus   @default(PENDING)
  
  // Valores
  amountCents   Int                 // Valor em centavos
  description   String              // Descrição da transação
  notes         String?             // Observações adicionais

  // Data da transação
  transactionDate DateTime          // Data efetiva da transação
  dueDate         DateTime?         // Data de vencimento (para pendentes)
  completedAt     DateTime?         // Data de conclusão do pagamento

  // Método de pagamento
  paymentMethod PaymentMethod?

  // Categoria
  categoryId  String?
  category    FinancialCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Vínculo com agendamento (para receitas de serviços)
  appointmentId String? @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  // Vínculo com cliente (opcional)
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  // Recorrência
  isRecurring     Boolean @default(false)  // É uma transação recorrente?
  recurringParentId String?                // ID da transação pai (para recorrentes)
  
  // Comprovante/anexo
  attachmentUrl String?

  @@index([workspaceId, type])
  @@index([workspaceId, transactionDate])
  @@index([workspaceId, status])
  @@index([categoryId])
  @@index([appointmentId])
}

// ==================== SISTEMA DE PLANOS E BILLING (Super Admin) ====================

enum SubscriptionStatus {
  ACTIVE        // Assinatura ativa
  TRIAL         // Período de teste
  PAST_DUE      // Pagamento atrasado
  CANCELLED     // Cancelada
  SUSPENDED     // Suspensa (inadimplência)
}

enum InvoiceStatus {
  DRAFT         // Rascunho (não enviada)
  PENDING       // Aguardando pagamento
  PAID          // Paga
  OVERDUE       // Vencida
  CANCELLED     // Cancelada
}

enum BillingCycle {
  MONTHLY       // Mensal
  QUARTERLY     // Trimestral
  SEMIANNUAL    // Semestral
  ANNUAL        // Anual
}

// Planos de assinatura configurados pelo Super Admin
model SubscriptionPlan {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name          String              // Ex: "Básico", "Profissional", "Premium"
  description   String?             // Descrição do plano
  
  // Preços por ciclo (em centavos)
  priceMonthly    Int               // Preço mensal
  priceQuarterly  Int?              // Preço trimestral
  priceSemiannual Int?              // Preço semestral
  priceAnnual     Int?              // Preço anual
  
  // Limites e recursos
  maxAppointments Int?              // Limite de agendamentos/mês (null = ilimitado)
  maxClients      Int?              // Limite de clientes
  maxTeamMembers  Int?              // Limite de membros da equipe
  chatbotEnabled  Boolean @default(true)  // Chatbot incluso?
  whatsappEnabled Boolean @default(true)  // WhatsApp incluso?
  financialEnabled Boolean @default(true) // Módulo financeiro incluso?
  pixPaymentEnabled Boolean @default(true) // Pagamento PIX incluso?
  
  // Recursos extras (JSON flexível)
  features        String[]          // Lista de recursos ("Suporte prioritário", etc.)
  
  // Ordenação e visibilidade
  sortOrder       Int      @default(0)    // Ordem de exibição
  isActive        Boolean  @default(true) // Plano ativo para venda?
  isHighlighted   Boolean  @default(false) // Destacar como "recomendado"?
  
  // Trial
  trialDays       Int      @default(7)    // Dias de teste grátis
  
  // Relações
  subscriptions   WorkspaceSubscription[]

  @@index([isActive, sortOrder])
}

// Assinatura de um workspace
model WorkspaceSubscription {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaceId String   @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  planId      String
  plan        SubscriptionPlan @relation(fields: [planId], references: [id])

  status      SubscriptionStatus @default(TRIAL)
  billingCycle BillingCycle @default(MONTHLY)

  // Datas
  trialEndsAt     DateTime?         // Quando o trial termina
  currentPeriodStart DateTime       // Início do período atual
  currentPeriodEnd   DateTime       // Fim do período atual
  cancelledAt     DateTime?         // Data do cancelamento
  
  // Desconto (cupom, negociação)
  discountPercent Int?              // Desconto em percentual
  discountNote    String?           // Motivo do desconto
  
  // Notas internas
  notes           String?           // Observações do admin

  invoices        SubscriptionInvoice[]

  @@index([status])
  @@index([currentPeriodEnd])
}

// Faturas de assinatura
model SubscriptionInvoice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptionId String
  subscription   WorkspaceSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Identificador único da fatura
  invoiceNumber   String   @unique   // Ex: "INV-2026-00001"
  
  // Valores
  amountCents     Int               // Valor da fatura
  discountCents   Int      @default(0) // Desconto aplicado
  totalCents      Int               // Total a pagar (amount - discount)
  
  // Datas
  dueDate         DateTime          // Data de vencimento
  paidAt          DateTime?         // Data do pagamento
  
  // Status
  status          InvoiceStatus @default(PENDING)
  
  // Período de referência
  periodStart     DateTime          // Início do período
  periodEnd       DateTime          // Fim do período
  
  // Descrição
  description     String?           // Descrição da cobrança
  
  // Pagamentos
  payments        InvoicePayment[]

  @@index([subscriptionId])
  @@index([status, dueDate])
}

// Pagamentos recebidos
model InvoicePayment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  invoiceId String
  invoice   SubscriptionInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  amountCents     Int               // Valor pago
  paymentMethod   String            // "PIX", "CREDIT_CARD", "BOLETO", etc.
  
  // Dados do pagamento
  transactionId   String?           // ID da transação no gateway
  gatewayResponse String?           // Resposta do gateway (JSON)
  
  // Comprovante
  receiptUrl      String?           // URL do comprovante
  notes           String?           // Observações

  @@index([invoiceId])
}

// Configurações globais do sistema de pagamento (Super Admin)
model SystemSettings {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  key       String   @unique        // Chave da configuração
  value     String                  // Valor (pode ser JSON)
  
  // Categorias de configuração:
  // "payment.pix_key" - Chave PIX do sistema
  // "payment.pix_key_type" - Tipo da chave PIX
  // "payment.pix_holder_name" - Nome do titular
  // "payment.pix_city" - Cidade
  // "payment.gateway" - Gateway ativo (manual, stripe, pagseguro)
  // "payment.gateway_config" - Configuração do gateway (JSON criptografado)
  // "billing.grace_period_days" - Dias de carência
  // "billing.auto_suspend" - Suspender automaticamente após X dias
}

