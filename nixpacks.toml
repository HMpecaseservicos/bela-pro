# Nixpacks config (Railway)
# Objetivo: build determinístico do monorepo e start da API.

# =============================================================================
# SETUP: Instala pacotes do sistema
# - nodejs: runtime Node.js
# - npm: gerenciador de pacotes
# - chromium: navegador para WhatsApp Bot (Puppeteer)
# - Libs necessárias para Chromium headless
# =============================================================================
[phases.setup]
nixPkgs = ["nodejs_20", "chromium"]
aptPkgs = ["libnss3", "libatk1.0-0", "libatk-bridge2.0-0", "libcups2", "libgbm1", "libasound2t64", "libpangocairo-1.0-0", "libxss1", "libgtk-3-0", "libxshmfence1", "libglu1"]

# =============================================================================
# INSTALL: Dependências Node.js
# =============================================================================
[phases.install]
cmds = [
  "npm ci --no-audit --no-fund"
]

# =============================================================================
# BUILD: Gera Prisma Client e compila API
# =============================================================================
[phases.build]
cmds = [
  "npm run db:generate",
  "npm run build -w @bela-pro/api"
]

# =============================================================================
# START: Executa migrações e inicia API
# =============================================================================
[start]
cmd = "npm run db:migrate:deploy && node apps/api/dist/main.js"

# =============================================================================
# VARIÁVEIS DE AMBIENTE (Puppeteer/WhatsApp)
# =============================================================================
[variables]
# Pula download do Chromium (usamos o do sistema via Nix)
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD = "true"
# PUPPETEER_EXECUTABLE_PATH é detectado automaticamente pelo código
